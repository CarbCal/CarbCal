<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Settings</title>
    <link rel="icon" type="image/png" href="CarbCal.png">
    <!-- Apple Touch Icon for Home Screen -->
    <link rel="apple-touch-icon" href="CarbCal.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="CarbCal">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Dark mode toggle fix attempt -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

        /* --- Base & Light Mode --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #212529;
            background-image: url('Bread.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            /* Fullscreen: no padding, draw under status bar */
            padding-top: 0;
        }

        /* Light mode overlay to match index.html */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: -1;
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
            position: sticky;
            top: 0;
            z-index: 1030;
            background-color: #ffffff !important;
            border-bottom: 1px solid rgba(0,0,0,.05);
        }
        /* Frosted navbar when enabled (match index.html) */
        .frosted .navbar { background-color: rgba(255,255,255,0.60) !important; -webkit-backdrop-filter: blur(12px) saturate(160%); backdrop-filter: blur(12px) saturate(160%); border-bottom: 1px solid rgba(255,255,255,0.35); }
        body.dark-mode.frosted .navbar { background-color: rgba(34,34,34,0.45) !important; border-bottom-color: rgba(255,255,255,0.18); }

        .navbar-brand {
            color: #212529;
        }

        .container h2, .container h3 {
            color: #212529;
        }

        .accordion-item {
            background-color: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,.1);
            margin-bottom: .5rem;
        }

        /* (reverted colorful accents) */

        .accordion-button {
            background-color: #f8f9fa;
            color: #212529;
            border-radius: 1.5rem;
        }
        
        .accordion-button:not(.collapsed) {
            background-color: #e7f1ff;
            color: #0c63e4;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .accordion-body {
            background-color: #fff;
            color: #212529;
            border-bottom-left-radius: 1.5rem;
            border-bottom-right-radius: 1.5rem;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }

        /* --- Dark Mode Overrides (match index.html) --- */
        body.dark-mode {
            background-color: #2d2d2d !important;
            color: #e0e0e0 !important;
        }

        body.dark-mode::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: -1;
        }

        body.dark-mode .navbar {
            background-color: #2d2d2d !important;
            color: #f8f9fa !important;
            border-bottom: 1px solid #333;
            box-shadow: 0 2px 4px rgba(0,0,0,.3);
        }

        body.dark-mode .navbar-brand {
            color: #f8f9fa !important;
        }

        body.dark-mode .container h2,
        body.dark-mode .container h3 {
            color: #f8f9fa !important;
        }
        
        body.dark-mode .accordion-item {
            background-color: #2d2d2d !important;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px rgba(0,0,0,.3);
        }

        body.dark-mode .accordion-button {
            background-color: #333 !important;
            color: #e0e0e0 !important;
            border-radius: 1.5rem;
        }
        
        body.dark-mode .accordion-button:not(.collapsed) {
            background-color: rgb(60, 60, 60) !important;
            color: #f8f9fa !important;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        body.dark-mode .accordion-body {
            background-color: #222222 !important;
            color: #f8f9fa !important;
            border-bottom-left-radius: 1.5rem;
            border-bottom-right-radius: 1.5rem;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
        body.dark-mode .text-muted { color: #bbb !important; }

        body.dark-mode .form-check-label {
            color: #e0e0e0 !important;
        }

        body.dark-mode .form-control {
            background-color: #222222 !important;
            color: #f8f9fa !important;
            border-color: #555 !important;
        }

        body.dark-mode .form-control:focus {
            background-color: #222222 !important;
            color: #f8f9fa !important;
            border-color: #777 !important;
            box-shadow: 0 0 0 0.25rem rgba(192, 192, 192, 0.25) !important;
        }

        body.dark-mode .form-control::placeholder {
            color: #bbb !important;
        }

        /* Dark modal background */
        body.dark-mode .modal-content { background-color: #222222; color: #f8f9fa; }
        body.dark-mode .btn-close { filter: invert(1); }
        .modal textarea { resize: none; }

        .form-check.form-switch {
            display: flex !important;
            align-items: center;
            padding-left: 0;
        }

        .form-check.form-switch .form-check-input {
            width: 3em;
            height: 1.5em;
        }

        .form-check.form-switch .form-check-label {
            margin-left: 0;
        }

        body.dark-mode #forceOpenFoodFactsToggle.form-check-input:checked {
            background-color: #0c63e4 !important;
            border-color: #0c63e4 !important;
        }
        body.dark-mode #forceOpenFoodFactsToggle.form-check-input {
            background-color: #444 !important;
            border-color: #888 !important;
        }
        /* Fix dark-mode switches/checkbox ticks in Test Settings */
        body.dark-mode .form-check-input {
            background-color: #444 !important;
            border-color: #888 !important;
        }
        /* Only hide default tick for regular checkboxes, not switches */
        body.dark-mode .form-check:not(.form-switch) .form-check-input:not(:checked) {
            background-image: none !important; /* avoid white tick when unchecked */
        }
        body.dark-mode .form-check-input:checked {
            background-color: #0c63e4 !important;
            border-color: #0c63e4 !important;
        }
        body.dark-mode .form-check-input:focus {
            box-shadow: 0 0 0 0.25rem rgba(13,110,253,0.25) !important;
        }
        /* Improve dark-mode switch styling (incl. Dark Mode toggle) */
        body.dark-mode .form-switch .form-check-input {
            background-color: #3a3a3a !important; /* track */
            border-color: #666 !important;
            /* Ensure the knob (dot) is white via Bootstrap var */
            --bs-form-switch-bg: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
        }
        body.dark-mode .form-switch .form-check-input:checked {
            background-color: #0d6efd !important; /* primary */
            border-color: #0d6efd !important;
        }
        body.dark-mode .form-switch .form-check-input:focus {
            box-shadow: 0 0 0 0.25rem rgba(13,110,253,0.25) !important;
        }
    </style>
    <script>
        // Fullscreen: allow drawing under the OS status bar in native builds
        (function ensureSafeArea() {
            const onReady = () => {
                try {
                    const cap = window.Capacitor;
                    const statusBar = cap && cap.Plugins && cap.Plugins.StatusBar;
                    if (statusBar && cap.isNativePlatform && cap.isNativePlatform()) {
                        statusBar.setOverlaysWebView({ overlay: true }).catch(() => {});
                    }
                } catch (_) { /* noop */ }
            };
            if (document.readyState === 'complete' || document.readyState === 'interactive') onReady();
            else document.addEventListener('DOMContentLoaded', onReady);
            window.addEventListener('capacitorNativeReady', onReady);
        })();
    </script>
    <script type="module">
        import { App } from 'https://cdn.jsdelivr.net/npm/@capacitor/app@latest/dist/esm/index.js';
        // Android hardware back: close modals, then go back or fallback to index
        try {
            App.addListener('backButton', ({ canGoBack }) => {
                const openModal = document.querySelector('.modal.show');
                if (openModal) { openModal.querySelector('[data-bs-dismiss="modal"]')?.click(); return; }
                if (canGoBack || document.referrer) history.back(); else window.location.href = 'index.html';
            });
        } catch {}
    </script>
</head>
<body>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Apply frosted UI like index.html (default ON)
            const applyFrosted = () => {
                const pref = localStorage.getItem('frostedUI');
                const on = (pref === null || pref === 'true');
                document.body.classList.toggle('frosted', on);
            };
            applyFrosted();
            window.addEventListener('storage', (e) => { if (e.key === 'frostedUI') applyFrosted(); });
            const applyGlass = () => {
                const pref = localStorage.getItem('glassTheme') === 'true';
                document.body.classList.toggle('glass-theme', !!pref);
            };
            applyGlass();
            window.addEventListener('storage', (e) => { if (e.key === 'glassTheme') applyGlass(); });
        });
    </script>
    <nav class="navbar">
        <div class="container-fluid">
            <button type="button" class="navbar-brand btn btn-link mb-0 h1 p-0" onclick="window.history.back()"><i class="bi bi-arrow-left"></i> Back</button>
        </div>
    </nav>

    <div class="container my-4">
        <h2 class="mb-4">Settings</h2>
        <div class="accordion mt-4" id="settingsAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingVisual">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVisual" aria-expanded="false" aria-controls="collapseVisual">
                        Visual
                    </button>
                </h2>
                <div id="collapseVisual" class="accordion-collapse collapse" aria-labelledby="headingVisual" data-bs-parent="#settingsAccordion">
                    <div class="accordion-body">
                        <div class="form-check form-switch d-flex justify-content-between align-items-center">
                            <label class="form-check-label" for="darkModeToggle"><i class="bi bi-moon-stars-fill"></i> Dark Mode</label>
                            <input class="form-check-input ms-auto" type="checkbox" id="darkModeToggle">
                        </div>
                        <div class="form-check form-switch d-flex justify-content-between align-items-center mt-2">
                            <label class="form-check-label" for="roundedItemsToggle"><i class="bi bi-ui-radios-grid"></i> More Rounded List Items</label>
                            <input class="form-check-input ms-auto" type="checkbox" id="roundedItemsToggle">
                        </div>
                        <div class="form-check form-switch d-flex justify-content-between align-items-center mt-2">
                            <label class="form-check-label" for="frostedUIToggle"><i class="bi bi-droplet-half"></i> Frosted Glass UI</label>
                            <input class="form-check-input ms-auto" type="checkbox" id="frostedUIToggle">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingSavedItems">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSavedItems" aria-expanded="false" aria-controls="collapseSavedItems">
                        Saved Items
                    </button>
                </h2>
                <div id="collapseSavedItems" class="accordion-collapse collapse" aria-labelledby="headingSavedItems" data-bs-parent="#settingsAccordion">
                    <div class="accordion-body">
                        <p class="mb-2">Export or import your saved items.</p>
                        <div class="d-flex gap-2 flex-wrap">
                            <button id="exportItemsBtn" class="btn btn-outline-secondary" title="Select items to export">
                                <i class="bi bi-download"></i> Select Items to Export
                            </button>
                            <button id="importCodeBtn" class="btn btn-outline-secondary" title="Import via Code">
                                <i class="bi bi-upload"></i> Import Code
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingOnlineSearch">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOnlineSearch" aria-expanded="false" aria-controls="collapseOnlineSearch">
                        Online Search
                    </button>
                </h2>
                <div id="collapseOnlineSearch" class="accordion-collapse collapse" aria-labelledby="headingOnlineSearch" data-bs-parent="#settingsAccordion">
                    <div class="accordion-body">
                        <div class="form-check form-switch d-flex justify-content-between align-items-center mb-3">
                            <label class="form-check-label" for="forceOpenFoodFactsToggle"><i class="bi bi-globe"></i> Force Open Food Facts API</label>
                            <input class="form-check-input ms-auto" type="checkbox" id="forceOpenFoodFactsToggle">
                        </div>

                        <div class="mb-3">
                            <label for="nutritionixAppId" class="form-label">Nutritionix App ID</label>
                            <input type="text" class="form-control" id="nutritionixAppId" placeholder="Enter Nutritionix App ID">
                        </div>
                        <div class="mb-3">
                            <label for="nutritionixAppKey" class="form-label">Nutritionix App Key</label>
                            <input type="password" class="form-control" id="nutritionixAppKey" placeholder="Enter Nutritionix App Key">
                        </div>
                        
                        
                        <button id="saveApiKeys" class="btn btn-primary">Save API Keys</button>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header" id="headingTest">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTest" aria-expanded="false" aria-controls="collapseTest">
                        Test Settings
                    </button>
                </h2>
                <div id="collapseTest" class="accordion-collapse collapse" aria-labelledby="headingTest" data-bs-parent="#settingsAccordion">
                    <div class="accordion-body">
                        <div class="form-check form-switch d-flex justify-content-between align-items-center">
                            <label class="form-check-label" for="alwaysShowWhatsNewToggle"><i class="bi bi-bell"></i> Always Show "What’s New" Popup</label>
                            <input class="form-check-input ms-auto" type="checkbox" id="alwaysShowWhatsNewToggle">
                        </div>
                        <small class="text-muted">When enabled, the What’s New summary pops up on launch even if you already saw this version.</small>

                        <hr>
                        <div class="form-check form-switch d-flex justify-content-between align-items-center">
                            <label class="form-check-label" for="alwaysShowTourToggle"><i class="bi bi-stars"></i> Always Show Onboarding Tour</label>
                            <input class="form-check-input ms-auto" type="checkbox" id="alwaysShowTourToggle">
                        </div>
                        <small class="text-muted">When enabled, the quick tour runs on every launch.</small>
                    </div>
                </div>
            </div>
            
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingAbout">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAbout" aria-expanded="false" aria-controls="collapseAbout">
                        About Carb Calculator
                    </button>
                </h2>
                <div id="collapseAbout" class="accordion-collapse collapse" aria-labelledby="headingAbout" data-bs-parent="#settingsAccordion">
                    <div class="accordion-body">
                        <p>This application helps you easily calculate carbohydrates, save your favorite food items, and find nutrition information online.</p>

                        <h4 class="mt-4">How to Use</h4>
                        <ul>
                            <li><strong>Dark Mode Toggle:</strong> Switch between light and dark themes in the "Visual" settings.</li>
                            <li><strong>Carb Calculator:</strong> Calculate total carbs based on per 100g values and weight.</li>
                            <li><strong>Online Search:</strong> Find nutrition data for various foods using external APIs.</li>
                            <li><strong>Saved Items:</strong> Store and manage your frequently used food items, and import/export them.</li>
                        </ul>

                        <div class="mt-3">
                            <button id="runTourBtn" class="btn btn-primary"><i class="bi bi-stars"></i> Run Quick Tour</button>
                            <small class="text-muted d-block mt-1">Opens the home screen and guides you through the basics.</small>
                        </div>

                        <h4 class="mt-4">Features in Detail</h4>
                        <h5 class="mt-2">1. Dark Mode Toggle</h5>
                        <p>Switch between a light and dark theme for comfortable viewing. Your preference is saved automatically. You can find the toggle switch in the <strong>Visual</strong> section of the settings.</p>

                        <h5 class="mt-4">2. Carb Calculator</h5>
                        <p>
                            Enter the "Carbohydrates per 100g" of your food and its "Weight of Food (g)" in the input fields. Click the <strong>"Calculate" button</strong> to see the total carbohydrates. The result will appear in a card below. You can then label your calculated item in the <strong>"Label your item" text box</strong> and click the <strong>"Add" button</strong> to save it to your "Saved Items" list. The <strong>"Close" button</strong> on the result card will hide it.
                        </p>

                        <h5 class="mt-4">3. Online Search</h5>
                        <p>
                            To search for food items online, navigate to the <strong>"Online Search" tab</strong>. Type your query into the <strong>search box</strong> and click the <strong>"Search" button</strong>. The app will try to find results using the Nutritionix API when credentials are provided; otherwise it uses Open Food Facts.
                            Click on any search result in the list to see detailed nutrition facts in a pop-up window. Click the <strong>"Use" button</strong> next to a search result to automatically fill the calculator with its carbohydrate and serving information.
                        </p>

                        <h5 class="mt-4">4. Saved Items</h5>
                        <p>
                            To manage your frequently used food items, navigate to the <strong>"Saved Items" tab</strong>. You can search through your saved items using the <strong>search input field</strong>.
                            Click the <strong>"Use" button</strong> next to a saved item to quickly load its details into the calculator.
                            Click the <strong>trash can icon</strong> to remove a saved item (you'll be asked to confirm in a pop-up).
                            Use the <strong>"Add Custom" button</strong> to manually add a new food item to your saved list by entering its label, serving size, and carbs per serving in the modal that appears.
                            You can also <strong>Import</strong> and <strong>Export</strong> your saved items as a JSON file.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const forceOpenFoodFactsToggle = document.getElementById('forceOpenFoodFactsToggle');
            const nutritionixAppIdInput = document.getElementById('nutritionixAppId');
            const nutritionixAppKeyInput = document.getElementById('nutritionixAppKey');
            
            const saveApiKeysButton = document.getElementById('saveApiKeys');
            const alwaysShowWhatsNewToggle = document.getElementById('alwaysShowWhatsNewToggle');
            const alwaysShowTourToggle = document.getElementById('alwaysShowTourToggle');
            const runTourBtn = document.getElementById('runTourBtn');

            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    document.body.classList.add('dark-mode');
                    if (darkModeToggle) {
                        darkModeToggle.checked = true;
                    }
                } else {
                    document.body.classList.remove('dark-mode');
                    if (darkModeToggle) {
                        darkModeToggle.checked = false;
                    }
                }
            };

            // Load saved preferences
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme('dark');
            }

            const forceOpenFoodFacts = localStorage.getItem('forceOpenFoodFacts');
            if (forceOpenFoodFacts === 'true') {
                forceOpenFoodFactsToggle.checked = true;
            } else {
                forceOpenFoodFactsToggle.checked = false;
            }

            // Load test setting
            alwaysShowWhatsNewToggle.checked = (localStorage.getItem('alwaysShowWhatsNew') === 'true');
            alwaysShowTourToggle.checked = (localStorage.getItem('alwaysShowTour') === 'true');
            // Rounded items default ON if unset
            const roundedItemsToggle = document.getElementById('roundedItemsToggle');
            const roundedPref = localStorage.getItem('roundedItems');
            roundedItemsToggle.checked = (roundedPref === null || roundedPref === 'true');
            // Frosted (default ON)
            const frostedUIToggle = document.getElementById('frostedUIToggle');
            const frostedPref = localStorage.getItem('frostedUI');
            frostedUIToggle.checked = (frostedPref === null || frostedPref === 'true');

            // Load API keys
            nutritionixAppIdInput.value = localStorage.getItem('nutritionixAppId') || '';
            nutritionixAppKeyInput.value = localStorage.getItem('nutritionixAppKey') || '';
            

            // Event Listeners for toggles
            darkModeToggle.addEventListener('click', () => {
                const theme = darkModeToggle.checked ? 'dark' : 'light';
                localStorage.setItem('theme', theme);
                applyTheme(theme);
            });

            forceOpenFoodFactsToggle.addEventListener('click', () => {
                localStorage.setItem('forceOpenFoodFacts', forceOpenFoodFactsToggle.checked);
            });

            alwaysShowWhatsNewToggle.addEventListener('click', () => {
                localStorage.setItem('alwaysShowWhatsNew', alwaysShowWhatsNewToggle.checked);
            });

            alwaysShowTourToggle.addEventListener('click', () => {
                localStorage.setItem('alwaysShowTour', alwaysShowTourToggle.checked);
            });
            roundedItemsToggle.addEventListener('click', () => {
                localStorage.setItem('roundedItems', roundedItemsToggle.checked ? 'true' : 'false');
            });
            frostedUIToggle.addEventListener('click', () => {
                localStorage.setItem('frostedUI', frostedUIToggle.checked ? 'true' : 'false');
            });

            if (runTourBtn) {
                runTourBtn.addEventListener('click', () => {
                    try { localStorage.setItem('forceTourNext', 'true'); } catch (_) {}
                    window.location.href = 'index.html?tour=1';
                });
            }

            // Event Listener for saving API keys
            saveApiKeysButton.addEventListener('click', () => {
                localStorage.setItem('nutritionixAppId', nutritionixAppIdInput.value);
                localStorage.setItem('nutritionixAppKey', nutritionixAppKeyInput.value);
                
                
                alert('API Keys saved!');
            });

            // Export/Import Saved Items
            const importItemsInput = document.getElementById('importItemsInput');
            const exportItemsBtn = document.getElementById('exportItemsBtn');
            const importCodeBtn = document.getElementById('importCodeBtn');

            // Import via code modal
            if (importCodeBtn) {
                // Build modal once
                const modalHtml = `
                <div class="modal fade" id="importCodeModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Import via Code</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p class="text-muted">Paste the code you received (or raw JSON), then import.</p>
                                <textarea id="importCodeText" class="form-control" rows="6" placeholder="Paste code here..."></textarea>
                                <div id="importCodeError" class="text-danger mt-2" style="display:none;">Invalid code. Please check and try again.</div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" id="doImportCodeBtn" class="btn btn-primary">Import</button>
                            </div>
                        </div>
                    </div>
                </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const importModalEl = document.getElementById('importCodeModal');
                const importModal = new bootstrap.Modal(importModalEl);
                const codeInput = () => document.getElementById('importCodeText');
                const codeError = () => document.getElementById('importCodeError');

                importCodeBtn.addEventListener('click', () => {
                    codeInput().value = '';
                    codeError().style.display = 'none';
                    importModal.show();
                });

                const tryDecode = (str) => {
                    const s = (str || '').trim();
                    if (!s) throw new Error('empty');
                    if (s.startsWith('[') || s.startsWith('{')) return JSON.parse(s);
                    const b64 = s.replace(/-/g,'+').replace(/_/g,'/');
                    const padLen = (4 - (b64.length % 4)) % 4;
                    const padded = b64 + '='.repeat(padLen);
                    const jsonStr = atob(padded);
                    return JSON.parse(jsonStr);
                };

                document.getElementById('doImportCodeBtn').addEventListener('click', () => {
                    try {
                        const parsed = tryDecode(codeInput().value);
                        if (!Array.isArray(parsed) || parsed.length === 0) throw new Error('not-array');
                        localStorage.setItem('importPreviewItems', JSON.stringify(parsed));
                        importModal.hide();
                        window.location.href = 'import.html';
                    } catch (e) {
                        codeError().style.display = 'block';
                    }
                });
            }

            if (exportItemsBtn) {
                exportItemsBtn.addEventListener('click', () => {
                    window.location.href = 'export.html';
                });
            }

            // Synchronize theme and API keys across tabs/windows
            window.addEventListener('storage', (event) => {
                if (event.key === 'theme') {
                    applyTheme(event.newValue);
                } else if (event.key === 'forceOpenFoodFacts') {
                    forceOpenFoodFactsToggle.checked = (event.newValue === 'true');
                } else if (event.key === 'alwaysShowWhatsNew') {
                    alwaysShowWhatsNewToggle.checked = (event.newValue === 'true');
                } else if (event.key === 'alwaysShowTour') {
                    alwaysShowTourToggle.checked = (event.newValue === 'true');
                } else if (event.key === 'nutritionixAppId') {
                    nutritionixAppIdInput.value = event.newValue || '';
                } else if (event.key === 'nutritionixAppKey') {
                    nutritionixAppKeyInput.value = event.newValue || '';
                } else if (event.key === 'roundedItems') {
                    const pref = (event.newValue === null || event.newValue === 'true');
                    const tgl = document.getElementById('roundedItemsToggle'); if (tgl) tgl.checked = pref;
                } else if (event.key === 'frostedUI') {
                    const tgl = document.getElementById('frostedUIToggle'); if (tgl) tgl.checked = (event.newValue === null || event.newValue === 'true');
                }
            });
        });
    </script>
</body>
</html>
