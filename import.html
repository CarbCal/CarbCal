<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import Saved Items</title>
    <link rel="icon" type="image/png" href="CarbCal.png">
    <link rel="apple-touch-icon" href="CarbCal.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="CarbCal">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-image: url('Bread.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: -1;
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
            position: sticky;
            top: 0;
            z-index: 1030;
        }

        .card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,.1);
            background-color: rgba(255, 255, 255, 0.9);
        }

        /* Dark Mode */
        body.dark-mode { background-color: #2d2d2d; }
        body.dark-mode::before { background-color: rgba(0,0,0,0.8); }
        body.dark-mode .navbar { background-color: #2d2d2d !important; color: #f8f9fa !important; box-shadow: 0 2px 4px rgba(0,0,0,.3); }
        body.dark-mode .navbar-brand { color: #f8f9fa !important; }
        body.dark-mode .card { background-color: #2d2d2d !important; color: #f8f9fa; box-shadow: 0 4px 6px rgba(0,0,0,.3); border: 1px solid rgba(255,255,255,0.2); }
        body.dark-mode .list-group-item { background-color: #222222 !important; color: #f8f9fa; border: 1px solid rgba(255,255,255,0.2); }
        body.dark-mode .form-check-label { color: #f8f9fa; }
        body.dark-mode .btn-outline-secondary { border-color: #888; color: #ddd; }
        body.dark-mode .modal-content { background-color: #222222; color: #f8f9fa; }
        body.dark-mode .text-muted { color: #bbb !important; }

        .controls { gap: .5rem; flex-wrap: wrap; }
        .controls .btn { flex: 0 0 auto; }

        .list-group-item { padding: .85rem .85rem; }
        .form-check-input { width: 1.25rem; height: 1.25rem; }

        /* Mobile tweaks */
        @media (max-width: 576px) {
            .controls { width: 100%; }
            .controls .btn { flex: 1 1 calc(50% - .5rem); }
            .form-check-label strong { font-size: 1rem; }
            .form-check-label small { font-size: .9rem; }
        }

        /* Sticky bottom action bar on mobile */
        .primary-action { position: sticky; bottom: 0; left: 0; right: 0; padding: .5rem calc(.5rem + env(safe-area-inset-right)) calc(.5rem + env(safe-area-inset-bottom)) calc(.5rem + env(safe-area-inset-left)); background: rgba(255,255,255,0.9); backdrop-filter: blur(6px); border-top: 1px solid rgba(0,0,0,.05); }
        body.dark-mode .primary-action { background: rgba(34,34,34,0.95); border-top-color: #444; }
        .primary-action .btn { width: 100%; }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const applyTheme = (theme) => {
                if (theme === 'dark') document.body.classList.add('dark-mode');
                else document.body.classList.remove('dark-mode');
            };
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) applyTheme(savedTheme);
            else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) applyTheme('dark');
            window.addEventListener('storage', (e) => { if (e.key === 'theme') applyTheme(e.newValue); });

            const previewRaw = localStorage.getItem('importPreviewItems');
            const listEl = document.getElementById('importList');
            const countEl = document.getElementById('itemsCount');
            const importBtn = document.getElementById('importSelectedBtn');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const deselectAllBtn = document.getElementById('deselectAllBtn');
            const emptyState = document.getElementById('emptyState');
            let items = [];

            const updateImportEnabled = () => {
                const anyChecked = !!listEl.querySelector('input[type="checkbox"]:checked');
                importBtn.disabled = !anyChecked;
            };

            const render = () => {
                listEl.innerHTML = '';
                items.forEach((item, idx) => {
                    const id = 'item_' + idx;
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${idx}" id="${id}">
                            <label class="form-check-label" for="${id}">
                                <strong>${(item.label || 'Unnamed')}</strong>
                                <small class="text-muted d-block">Serving: ${Number(item.servingSize||0).toFixed(1)}g | Carbs: ${Number(item.totalCarbs||0).toFixed(1)}g</small>
                            </label>
                        </div>
                    `;
                    listEl.appendChild(li);
                });
                countEl.textContent = items.length;
                updateImportEnabled();
            };

            if (!previewRaw) {
                emptyState.style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
                const loadBtn = document.getElementById('loadPastedBtn');
                const pasteInput = document.getElementById('pasteImportInput');
                loadBtn.addEventListener('click', () => {
                    try {
                        const val = (pasteInput.value || '').trim();
                        const tryDecode = (str) => {
                            // If looks like JSON array/object, parse directly
                            if (str.startsWith('[') || str.startsWith('{')) return JSON.parse(str);
                            // Otherwise treat as URL-safe Base64
                            const b64 = str.replace(/-/g,'+').replace(/_/g,'/');
                            const pad = b64.length % 4 === 2 ? '==' : (b64.length % 4 === 3 ? '=' : '');
                            const jsonStr = atob(b64 + pad);
                            return JSON.parse(jsonStr);
                        };
                        const parsed = tryDecode(val);
                        if (!Array.isArray(parsed) || parsed.length === 0) throw new Error('Invalid');
                        localStorage.setItem('importPreviewItems', JSON.stringify(parsed));
                        window.location.reload();
                    } catch (_) {
                        pasteInput.classList.add('is-invalid');
                        setTimeout(() => pasteInput.classList.remove('is-invalid'), 1200);
                    }
                });
                return;
            }
            try {
                const parsed = JSON.parse(previewRaw);
                if (!Array.isArray(parsed) || parsed.length === 0) throw new Error('Invalid');
                // Normalize minimal structure
                items = parsed.filter(i => i && (i.label || '').trim() !== '');
                if (items.length === 0) throw new Error('Empty');
                render();
            } catch (e) {
                emptyState.style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
                return;
            }

            selectAllBtn.addEventListener('click', () => {
                listEl.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
                updateImportEnabled();
            });
            deselectAllBtn.addEventListener('click', () => {
                listEl.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                updateImportEnabled();
            });
            listEl.addEventListener('change', updateImportEnabled);

            importBtn.addEventListener('click', () => {
                const selectedIdx = Array.from(listEl.querySelectorAll('input[type="checkbox"]'))
                    .filter(cb => cb.checked)
                    .map(cb => Number(cb.value));
                if (selectedIdx.length === 0) return;
                const selectedItems = selectedIdx.map(i => items[i]).filter(Boolean);

                const current = JSON.parse(localStorage.getItem('savedItems')) || [];
                const existing = new Set(current.map(i => (i.label || '').toLowerCase()));
                let added = 0;
                selectedItems.forEach(item => {
                    const label = (item.label || '').toLowerCase();
                    if (!existing.has(label)) {
                        current.push(item);
                        existing.add(label);
                        added++;
                    }
                });
                localStorage.setItem('savedItems', JSON.stringify(current));
                localStorage.removeItem('importPreviewItems');
                const msg = added > 0 ? `Imported ${added} new item(s).` : 'No new items were imported.';
                const modalBody = document.getElementById('importResultText');
                const modalEl = document.getElementById('importResultModal');
                if (modalBody && modalEl && window.bootstrap) {
                    modalBody.textContent = msg;
                    const resultModal = new bootstrap.Modal(modalEl);
                    modalEl.addEventListener('hidden.bs.modal', () => { window.location.href = 'settings.html'; }, { once: true });
                    resultModal.show();
                } else {
                    alert(msg);
                    window.location.href = 'settings.html';
                }
            });
            // If on small screens, move the primary action button to the sticky footer
            const footerAction = document.getElementById('footerAction');
            const isMobile = window.matchMedia('(max-width: 576px)').matches;
            if (footerAction && isMobile) {
                footerAction.appendChild(importBtn);
                importBtn.classList.remove('btn-sm');
                importBtn.classList.add('btn-lg');
            }

            window.addEventListener('resize', () => {
                const mobile = window.matchMedia('(max-width: 576px)').matches;
                if (footerAction) {
                    if (mobile && importBtn.parentElement !== footerAction) {
                        footerAction.appendChild(importBtn);
                        importBtn.classList.remove('btn-sm');
                        importBtn.classList.add('btn-lg');
                    } else if (!mobile && importBtn.parentElement === footerAction) {
                        document.querySelector('.controls')?.appendChild(importBtn);
                        importBtn.classList.remove('btn-lg');
                        importBtn.classList.add('btn-sm');
                    }
                }
            });
        });
    </script>
    <style>
        .info-fab { position: fixed; bottom: 20px; right: 20px; z-index: 1050; border-radius: .5rem; }
    </style>
    <!-- Bootstrap JS (needed for modal) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-light bg-light">
        <div class="container-fluid">
            <a href="settings.html" class="navbar-brand mb-0 h1"><i class="bi bi-arrow-left"></i> Back</a>
        </div>
    </nav>

    <div class="container my-4" id="mainContent">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
                    <h3 class="mb-2 mb-md-0">Select Items to Import <small class="text-muted">(<span id="itemsCount">0</span>)</small></h3>
                    <div class="controls d-flex">
                        <button id="selectAllBtn" class="btn btn-outline-secondary btn-sm"><i class="bi bi-check2-square"></i> Select All</button>
                        <button id="deselectAllBtn" class="btn btn-outline-secondary btn-sm"><i class="bi bi-square"></i> Deselect All</button>
                        <button id="importSelectedBtn" class="btn btn-primary btn-sm" disabled><i class="bi bi-download"></i> Import Selected</button>
                    </div>
                </div>
                <ul id="importList" class="list-group"></ul>
            </div>
        </div>
    </div>

    <!-- Sticky action bar on mobile -->
    <div class="container d-sm-none" id="footerActionWrapper">
        <div id="footerAction" class="primary-action"></div>
    </div>

    <div class="container my-4" id="emptyState" style="display:none;">
        <div class="card">
            <div class="card-body">
                <h4 class="mb-2">Import From Text</h4>
                <p class="text-muted">Paste the shareable text you received, then load it.</p>
                <textarea id="pasteImportInput" class="form-control mb-2" rows="6" placeholder='Paste JSON here...'></textarea>
                <div class="d-flex gap-2">
                    <button id="loadPastedBtn" class="btn btn-primary"><i class="bi bi-download"></i> Load Text</button>
                    <a href="settings.html" class="btn btn-secondary">Back to Settings</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Import result modal -->
    <div class="modal fade" id="importResultModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import Complete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="importResultText" class="mb-0">Imported items.</p>
                </div>
                <div class="modal-footer">
                    <a href="settings.html" class="btn btn-primary">Done</a>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
