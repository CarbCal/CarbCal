<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export Saved Items</title>
    <link rel="icon" type="image/png" href="CarbCal.png">
    <link rel="apple-touch-icon" href="CarbCal.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="CarbCal">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-image: url('Bread.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: -1;
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
            position: sticky;
            top: 0;
            z-index: 1030;
        }

        .card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,.1);
            background-color: rgba(255, 255, 255, 0.9);
        }

        /* Dark Mode */
        body.dark-mode { background-color: #2d2d2d; }
        body.dark-mode::before { background-color: rgba(0,0,0,0.8); }
        body.dark-mode .navbar { background-color: #2d2d2d !important; color: #f8f9fa !important; box-shadow: 0 2px 4px rgba(0,0,0,.3); }
        body.dark-mode .navbar-brand { color: #f8f9fa !important; }
        body.dark-mode .card { background-color: #2d2d2d !important; color: #f8f9fa; box-shadow: 0 4px 6px rgba(0,0,0,.3); border: 1px solid rgba(255,255,255,0.2); }
        body.dark-mode .list-group-item { background-color: #222222 !important; color: #f8f9fa; border: 1px solid rgba(255,255,255,0.2); }
        body.dark-mode .form-check-label { color: #f8f9fa; }
        /* Darker unchecked checkbox in dark mode */
        body.dark-mode .form-check-input { background-color: #222222; border-color: #666; }
        body.dark-mode .form-check-input:focus { box-shadow: 0 0 0 0.2rem rgba(255,255,255,0.1); border-color: #888; }
        body.dark-mode .form-check-input:checked { background-color: #0c63e4; border-color: #0c63e4; }
        body.dark-mode .btn-outline-secondary { border-color: #888; color: #ddd; }
        body.dark-mode .modal-content { background-color: #222222; color: #f8f9fa; }
        body.dark-mode .btn-close { filter: invert(1); }
        .modal textarea { resize: none; }
        body.dark-mode .input-group-text { background-color: #333; color: #f8f9fa; border-color: #555; }
        body.dark-mode .form-control { background-color: #222222; color: #f8f9fa; border-color: #555; }
        body.dark-mode .form-control:focus { background-color: #222222; color: #f8f9fa; border-color: #777; box-shadow: 0 0 0 0.25rem rgba(192,192,192,0.25); }
        body.dark-mode .form-control::placeholder { color: #bbb; }
        body.dark-mode .text-muted { color: #bbb !important; }

        .controls { gap: .5rem; flex-wrap: wrap; }
        .controls .btn { flex: 0 0 auto; }

        .list-group-item { padding: .85rem .85rem; }
        .form-check-input { width: 1.25rem; height: 1.25rem; }
        /* Center the checkbox relative to multi-line labels */
        .list-group-item .form-check { display: flex; align-items: center; gap: .5rem; }
        .list-group-item .form-check-input { margin-top: 0; float: none; }

        /* Mobile tweaks */
        @media (max-width: 576px) {
            .controls { width: 100%; }
            .controls .btn { flex: 1 1 calc(50% - .5rem); }
            .form-check-label strong { font-size: 1rem; }
            .form-check-label small { font-size: .9rem; }
        }

        /* Sticky bottom action bar on mobile */
        .primary-action { position: sticky; bottom: 0; left: 0; right: 0; padding: .5rem calc(.5rem + env(safe-area-inset-right)) calc(.5rem + env(safe-area-inset-bottom)) calc(.5rem + env(safe-area-inset-left)); background: rgba(255,255,255,0.9); backdrop-filter: blur(6px); border-top: 1px solid rgba(0,0,0,.05); }
        body.dark-mode .primary-action { background: rgba(34,34,34,0.95); border-top-color: #444; }
        .primary-action .btn { width: 100%; }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const applyTheme = (theme) => {
                if (theme === 'dark') document.body.classList.add('dark-mode');
                else document.body.classList.remove('dark-mode');
            };
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) applyTheme(savedTheme);
            else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) applyTheme('dark');
            window.addEventListener('storage', (e) => { if (e.key === 'theme') applyTheme(e.newValue); });

            const listEl = document.getElementById('exportList');
            const countEl = document.getElementById('itemsCount');
            const exportBtn = document.getElementById('exportSelectedBtn');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const deselectAllBtn = document.getElementById('deselectAllBtn');
            const emptyState = document.getElementById('emptyState');
            const searchInput = document.getElementById('exportSearchInput');
            let items = JSON.parse(localStorage.getItem('savedItems')) || [];
            let searchTerm = '';

            if (!items || items.length === 0) {
                emptyState.style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
                return;
            }

            const getKey = (item) => (item && (item.id != null ? String(item.id) : (item.label || '')));
            const selectedKeys = new Set();

            const updateCount = () => {
                // Show (selected/total)
                countEl.textContent = `${selectedKeys.size}/${items.length}`;
            };

            const updateExportEnabled = () => {
                exportBtn.disabled = selectedKeys.size === 0;
                updateCount();
            };

            const getFiltered = () => {
                const term = (searchTerm || '').trim().toLowerCase();
                if (!term) return items.slice();
                return items.filter(i => (i.label || '').toLowerCase().includes(term));
            };

            const render = () => {
                listEl.innerHTML = '';
                const filtered = getFiltered();
                filtered.forEach((item, idx) => {
                    const id = 'item_' + idx;
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${idx}" id="${id}">
                            <label class="form-check-label" for="${id}">
                                <strong>${(item.label || 'Unnamed')}</strong>
                                <small class="text-muted d-block">Serving: ${Number(item.servingSize||0).toFixed(1)}g | Carbs: ${Number(item.totalCarbs||0).toFixed(1)}g</small>
                            </label>
                        </div>
                    `;
                    // Preserve selection across renders/filters
                    const key = getKey(item);
                    const input = li.querySelector('input[type="checkbox"]');
                    input.checked = selectedKeys.has(key);
                    input.addEventListener('change', () => {
                        if (input.checked) selectedKeys.add(key); else selectedKeys.delete(key);
                        updateExportEnabled();
                    });
                    listEl.appendChild(li);
                });
                updateExportEnabled();
            };

            render();

            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    searchTerm = searchInput.value || '';
                    render();
                });
            }

            selectAllBtn.addEventListener('click', () => {
                getFiltered().forEach(item => selectedKeys.add(getKey(item)));
                render();
            });
            deselectAllBtn.addEventListener('click', () => {
                getFiltered().forEach(item => selectedKeys.delete(getKey(item)));
                render();
            });
            listEl.addEventListener('change', updateExportEnabled);

            const toUrlSafeBase64 = (s) => btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');

            exportBtn.addEventListener('click', () => {
                if (selectedKeys.size === 0) return;
                const selectedItems = items.filter(item => selectedKeys.has(getKey(item)));
                const json = JSON.stringify(selectedItems);
                const code = toUrlSafeBase64(json);

                const codeEl = document.getElementById('exportCodeText');
                if (codeEl) codeEl.value = code;
                const modalEl = document.getElementById('exportCodeModal');
                if (modalEl && window.bootstrap) {
                    const m = new bootstrap.Modal(modalEl);
                    m.show();
                }
            });
            // If on small screens, move the primary action button to the sticky footer
            const footerAction = document.getElementById('footerAction');
            const isMobile = window.matchMedia('(max-width: 576px)').matches;
            if (footerAction && isMobile) {
                footerAction.appendChild(exportBtn);
                exportBtn.classList.remove('btn-sm');
                exportBtn.classList.add('btn-lg');
            }

            window.addEventListener('resize', () => {
                const mobile = window.matchMedia('(max-width: 576px)').matches;
                if (footerAction) {
                    if (mobile && exportBtn.parentElement !== footerAction) {
                        footerAction.appendChild(exportBtn);
                        exportBtn.classList.remove('btn-sm');
                        exportBtn.classList.add('btn-lg');
                    } else if (!mobile && exportBtn.parentElement === footerAction) {
                        document.querySelector('.controls')?.appendChild(exportBtn);
                        exportBtn.classList.remove('btn-lg');
                        exportBtn.classList.add('btn-sm');
                    }
                }
            });
            const copyCodeBtn = document.getElementById('copyExportCodeBtn');
            copyCodeBtn.addEventListener('click', async () => {
                const codeEl = document.getElementById('exportCodeText');
                if (!codeEl || !codeEl.value) return;
                try {
                    await navigator.clipboard.writeText(codeEl.value);
                    const prev = copyCodeBtn.innerHTML;
                    copyCodeBtn.innerHTML = '<i class="bi bi-check2"></i> Copied';
                    setTimeout(() => copyCodeBtn.innerHTML = prev, 1200);
                } catch (_) {
                    codeEl.select();
                    document.execCommand('copy');
                }
            });
        });
    </script>
    <style>
        .info-fab { position: fixed; bottom: 20px; right: 20px; z-index: 1050; border-radius: .5rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-light bg-light">
        <div class="container-fluid">
            <a href="settings.html" class="navbar-brand mb-0 h1"><i class="bi bi-arrow-left"></i> Back</a>
        </div>
    </nav>

    <div class="container my-4" id="mainContent">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
                    <h3 class="mb-2 mb-md-0">Select Items to Export <small class="text-muted">(<span id="itemsCount">0</span>)</small></h3>
                    <div class="controls d-flex">
                        <button id="selectAllBtn" class="btn btn-outline-secondary btn-sm"><i class="bi bi-check2-square"></i> Select All</button>
                        <button id="deselectAllBtn" class="btn btn-outline-secondary btn-sm"><i class="bi bi-square"></i> Deselect All</button>
                        <button id="exportSelectedBtn" class="btn btn-primary btn-sm" disabled><i class="bi bi-clipboard-check"></i> Export</button>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" id="exportSearchInput" class="form-control" placeholder="Search saved items...">
                    </div>
                </div>
                <ul id="exportList" class="list-group mb-1"></ul>
                <small class="text-muted">Export creates a compact code you can copy and send.</small>
            </div>
        </div>
    </div>

    <!-- Sticky action bar on mobile -->
    <div class="container d-sm-none" id="footerActionWrapper">
        <div id="footerAction" class="primary-action"></div>
    </div>

    <div class="container my-4" id="emptyState" style="display:none;">
        <div class="card">
            <div class="card-body text-center">
                <h4>No saved items found</h4>
                <p class="text-muted">Add items first, then export.</p>
                <a href="settings.html" class="btn btn-secondary">Back to Settings</a>
            </div>
        </div>
    </div>

    <!-- Export code modal -->
    <div class="modal fade" id="exportCodeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Shareable Export Code</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Copy this code and send it. The recipient can paste it on the Import page.</p>
                    <textarea id="exportCodeText" class="form-control" rows="5" readonly></textarea>
                </div>
                <div class="modal-footer">
                    <button id="copyExportCodeBtn" class="btn btn-outline-secondary"><i class="bi bi-clipboard"></i> Copy</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Done</button>
                </div>
            </div>
        </div>
    </div>
    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
<!-- end -->
</html>
